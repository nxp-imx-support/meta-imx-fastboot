From 234d89a7ef89ccd24f7fa119de28f8606c928bb0 Mon Sep 17 00:00:00 2001
From: Elena Popa <elena.popa@nxp.com>
Date: Fri, 13 Dec 2024 17:36:05 +0200
Subject: [PATCH] imx8mq: add falcon mode support

Signed-off-by: Elena Popa <elena.popa@nxp.com>
---
 board/freescale/imx8mq_evk/spl.c | 16 +++++++++++++++-
 include/configs/imx8mq_evk.h     |  4 +++-
 2 files changed, 18 insertions(+), 2 deletions(-)

diff --git a/board/freescale/imx8mq_evk/spl.c b/board/freescale/imx8mq_evk/spl.c
index c7775c326fc..ba2adefe464 100644
--- a/board/freescale/imx8mq_evk/spl.c
+++ b/board/freescale/imx8mq_evk/spl.c
@@ -1,6 +1,6 @@
 // SPDX-License-Identifier: GPL-2.0+
 /*
- * Copyright 2018 - 2023 NXP
+ * Copyright 2018 - 2024 NXP
  *
  */
 
@@ -33,12 +33,26 @@
 #include <asm/arch/imx8mq_sec_def.h>
 #include <asm/arch/imx8m_csu.h>
 #include <asm/arch/imx8m_rdc.h>
+#include <serial.h>
 
 DECLARE_GLOBAL_DATA_PTR;
 
 extern struct dram_timing_info dram_timing_b0;
 extern struct dram_timing_info dram_timing_4g;
 
+#ifdef CONFIG_SPL_OS_BOOT
+int spl_start_uboot(void) {
+	if (IS_ENABLED(CONFIG_SPL_SERIAL) && serial_tstc() && serial_getc()) {
+	/* break into full u boot if any key is pressed */
+		while(serial_tstc()) { /* eat up all the remaining characters */
+			serial_getc();
+		}
+		return 1;
+	}
+	return 0; // start the Kernel
+}
+#endif
+
 static void spl_dram_init(void)
 {
 	/* Check PCA6416A IO EXP on 4GB WEVK only */
diff --git a/include/configs/imx8mq_evk.h b/include/configs/imx8mq_evk.h
index 7b308748f90..90349edf14b 100644
--- a/include/configs/imx8mq_evk.h
+++ b/include/configs/imx8mq_evk.h
@@ -1,6 +1,6 @@
 /* SPDX-License-Identifier: GPL-2.0+ */
 /*
- * Copyright 2018 NXP
+ * Copyright 2018, 2024 NXP
  */
 
 #ifndef __IMX8M_EVK_H
@@ -91,11 +91,13 @@
 	"mmcroot=/dev/mmcblk1p2 rootwait rw\0" \
 	"mmcautodetect=yes\0" \
 	"mmcargs=setenv bootargs ${jh_clk} ${mcore_clk} console=${console} root=${mmcroot}\0 " \
+	"mmcargs_fastboot=setenv bootargs ${jh_clk} ${mcore_clk} console=${console} root=${mmcroot} quiet\0 " \
 	"loadbootscript=fatload mmc ${mmcdev}:${mmcpart} ${loadaddr} ${bsp_script};\0" \
 	"bootscript=echo Running bootscript from mmc ...; " \
 		"source\0" \
 	"loadimage=fatload mmc ${mmcdev}:${mmcpart} ${loadaddr} ${image}\0" \
 	"loadfdt=fatload mmc ${mmcdev}:${mmcpart} ${fdt_addr_r} ${fdtfile}\0" \
+	"prepare_fdt=run loadfdt;ext2load mmc ${mmcdev}:2 ${loadaddr} /home/root/.falcon/uImage;run mmcargs_fastboot;spl export fdt ${loadaddr} - ${fdt_addr_r};fatwrite mmc ${mmcdev}:${mmcpart} ${fdt_addr_r} " CONFIG_SPL_FS_LOAD_ARGS_NAME " ${fdtargslen}\0" \
 	"mmcboot=echo Booting from mmc ...; " \
 		"run mmcargs; " \
 		"if test ${boot_fdt} = yes || test ${boot_fdt} = try; then " \
-- 
2.25.1

